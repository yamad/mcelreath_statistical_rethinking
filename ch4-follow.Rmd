# Howell (!Kung San anthropological data)

## Gaussian model of height

$$
\begin{align}
h_i &\sim \text{Normal}(\mu, \sigma)  \tag{likelihood}\\
\mu &\sim \text{Normal}(178, 20) \tag{$\mu$ prior}\\
\sigma &\sim \text{Normal}(0, 50) \tag{$\sigma$ prior}\\
\end{align}
$$

Model expects height will be a Gaussian distribution with a mean falling between $178 \pm 40$ cm with $95%$ probability, and a standard deviation of $50$ cm. That is, $95%$ of individual heights will be within $100$ cm of the average.

```{r setup-model}
library(rethinking)
data(Howell1)
d <- Howell1
d2 <- d[ d$age >= 18 , ]                # filter out children (for now)

par(mfrow=c(1,2))
## display prior for mu
curve( dnorm( x , 178 , 20 ) , from=100 , to=250)
## display prior for sigma
curve( dunif( x , 0 , 50 ) , from=-10 , to=60)


## sample from joint prior
sample_mu <- rnorm( 1e4 , 178 , 20 )
sample_sigma <- runif( 1e4 , 0 , 50 )
prior_h <- rnorm( 1e4 , sample_mu , sample_sigma )
par(mfrow=c(1,1))
dens( prior_h )
```

## Grid approximation


```{r}
## calculate posterior using grid approx
mu.list <- seq( from=140, to=160 , length.out=200 )
sigma.list <- seq( from=4 , to=9 , length.out=200 )
post <- expand.grid( mu=mu.list , sigma=sigma.list )
post$LL <- sapply( 1:nrow(post) , function(i) sum( dnorm(
                d2$height ,
                mean=post$mu[i] ,
                sd=post$sigma[i] ,
                log=TRUE ) ) )
post$prod <- post$LL + dnorm( post$mu , 178 , 20 , TRUE ) +
    dunif( post$sigma , 0 , 50 , TRUE )
post$prob <- exp( post$prod - max(post$prod) )

## display
par(mfrow=c(1,2))
contour_xyz( post$mu , post$sigma , post$prob )
image_xyz( post$mu , post$sigma , post$prob )


## sample rows from the posterior, in proportion to probability
sample.rows <- sample( 1:nrow(post) , size=1e4 , replace=TRUE ,
                      prob=post$prob )
sample.mu <- post$mu[ sample.rows ]
sample.sigma <- post$sigma[ sample.rows ]

## examine joint posterior
par(mfrow=c(1,1))
plot( sample.mu , sample.sigma , cex=0.5 , pch=16 , col=col.alpha(rangi2,0.1) )

## examine marginals
par(mfrow=c(1,2))
dens( sample.mu )
dens( sample.sigma )

## summarize with highest posterior density interval
HPDI( sample.mu )
HPDI( sample.sigma )
```

### Sigma will not necessarily be Gaussian

```{r}
## R code 4.21
d3 <- sample( d2$height , size=20 )

## R code 4.22
mu.list <- seq( from=150, to=170 , length.out=200 )
sigma.list <- seq( from=4 , to=20 , length.out=200 )
post2 <- expand.grid( mu=mu.list , sigma=sigma.list )
post2$LL <- sapply( 1:nrow(post2) , function(i)
    sum( dnorm( d3 , mean=post2$mu[i] , sd=post2$sigma[i] ,
    log=TRUE ) ) )
post2$prod <- post2$LL + dnorm( post2$mu , 178 , 20 , TRUE ) +
    dunif( post2$sigma , 0 , 50 , TRUE )
post2$prob <- exp( post2$prod - max(post2$prod) )
sample2.rows <- sample( 1:nrow(post2) , size=1e4 , replace=TRUE ,
    prob=post2$prob )
sample2.mu <- post2$mu[ sample2.rows ]
sample2.sigma <- post2$sigma[ sample2.rows ]
plot( sample2.mu , sample2.sigma , cex=0.5 ,
    col=col.alpha(rangi2,0.1) ,
    xlab="mu" , ylab="sigma" , pch=16 )

## R code 4.23
dens( sample2.sigma , norm.comp=TRUE )
```

# Fit the model with MAP (quadratic approximation)

`mu` and `sigma` are parameters of the model.

```{r map-model}
flist <- alist(
  height ~ dnorm(mu, sigma),            # Gaussian likelihood
  mu ~ dnorm(178, 20),                  # mu prior
  sigma ~ dunif(0, 50)                  # sigma prior
)

m4.1 <- map(flist, data=d2)             # fit model flist to data d2
precis(m4.1)                            # summary
```

A place to play with priors:

```{r}
m4.2 <- map(
  alist(
    height ~ dnorm(mu, sigma),
    mu ~ dnorm(120, 10),
    sigma ~ dunif(0, 50)
  ),
  data=d2)
precis(m4.2)
```

The MAP estimate makes a Gaussian approximation for each parameter of the model. The posterior then combines these into a single distribution: a multivariate Gaussian. It is described by a list of means (one for each dimension) and a _variance-covariance matrix_, which describes how each parameter in the model relates to every other parameter:

```{r vcov-matrix}
vcov(m4.1)                              # variance-covariance matrix

diag(vcov(m4.1))                        # variances for each parameter
cov2cor(vcov(m4.1))                     # correlation matrix
```

### Sidebar: Sampling from a multivariate Gaussian:

```{r}
post <- extract.samples(m4.1, n=1e4)
head(post)
precis(post)

library(MASS)
post2 <- mvrnorm(n=1e4, mu=coef(m4.1), Sigma=vcov(m4.1)) # how extract.samples works
```

### Sidebar: Using $\log{\sigma} as parameter

```{r log-sigma}
m4.1_logsigma <- map(
  alist(
    height ~ dnorm(mu, exp(log_sigma)), # convert in likelihood
    mu ~ dnorm(178, 20),
    log_sigma ~ dnorm(2, 10)            # log_sigma has Gaussian prior
  ), data=d2)

post3 <- extract.samples(m4.1_logsigma)
sigma3 <- exp(post3$log_sigma)            # convert from log units
```

## Predictor: how do height and weight covary?

```{r}
ggplot(d2) +
  geom_point(aes(x=weight, y=height), color="blue", alpha=0.7) +
  xlab("weight (kg)") +
  ylab("height (cm)")
```

The new model:

$$
\begin{align*}
h_i &\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta x_i \\
\alpha &\sim \text{Normal}(178, 100) \\
\beta &\sim \text{Normal}(0, 10) \\
\sigma &\sim \text{Uniform}(0, 50)
\end{align*}
$$

```{r linear-model}
m4.3 <- map(
  alist(
    height ~ dnorm(mu, sigma),
    mu <- a + b*weight,
    a ~ dnorm(178, 100),
    b ~ dnorm(0, 10),
    sigma ~ dunif(0, 50)
  ), data=d2)

precis(m4.3, corr=TRUE)
```

Centering the predictor

```{r}
d2$weight.c <- d2$weight - mean(d2$weight)
m4.4 <- map(
  alist(
    height ~ dnorm(mu, sigma),
    mu <- a + b*weight.c,
    a ~ dnorm(178, 100),
    b ~ dnorm(0, 10),
    sigma ~ dunif(0, 50)
  ), data=d2)
precis(m4.4, corr=TRUE)
```

Plotting the MAP values

```{r plot-map-simple}
plot(height ~ weight, data=d2, col="lightblue")
abline(a=coef(m4.3)["a"], b=coef(m4.3)["b"])
```

Plotting sampled lines from posterior fit

```{r}
plot_w_lines <- function(N) {
  ##
  dN <- d2[1:N, ]
  mN <- map(
    alist(
      height ~ dnorm(mu, sigma),
      mu <- a + b*weight,
      a ~ dnorm(178, 100),
      b ~ dnorm(0, 10),
      sigma ~ dunif(0, 50)
    ), data=dN)

  ## extract 20 samples from the posterior
  post <- extract.samples(mN, n=20)

  ## display raw data and sample size
  plot(dN$weight, dN$height,
       xlim=range(d2$weight), ylim=range(d2$height),
       col=rangi2, xlab="weight", ylab="height")
  mtext(concat("N = ", N))

  for (i in 1:20)
    abline(a=post$a[i], b=post$b[i], col=col.alpha("black",0.3))
}

par(mfrow=c(2,2))
sapply(c(10, 50, 150, 352), plot_w_lines)
```

Plotting an interval around a line

```{r}
## example for mu distribution for one value of weight
post <- extract.samples(m4.3)
mu_at_50 <- post$a + post$b * 50
dens(mu_at_50, col=rangi2, lwd=2, xlab="mu|weight=50")

mu <- link(m4.3)       # each column is an individual in original data
```

Getting distribution for mean value for each weight.

```{r}
par(mfrow=c(1,2))
## get 1000 plausible mu values for each weight
weight.seq <- seq(from=25, to=70, by=1)
mu <- link(m4.3, data=data.frame(weight=weight.seq))

## plot the first 100 of these samples.
##   there is a Gaussian at each weight
plot(height ~ weight, d2, type="n")
for (i in 1:100)
  points(weight.seq, mu[i,], pch=16, col=col.alpha(rangi2,0.1))

## summarize mu
mu.mean <- apply(mu, 2, mean)
mu.HPDI <- apply(mu, 2, HPDI, prob=0.89)

plot(height ~ weight, data=d2, col=col.alpha(rangi2,0.5))
lines(weight.seq, mu.mean)              # plot MAP line
shade(mu.HPDI, weight.seq)
```

### How `link` works

```{r}
post <- extract.samples(m4.3)
mu.link <- function(weight) post$a + post$b * weight
weight.seq <- seq(from=25, to=70, by=1)
mu <- sapply(weight.seq, mu.link)
mu.mean <- apply(mu, 2, mean)
mu.HPDI <- apply(mu, 2, HPDI, prob=0.89)
```

## Prediction Intervals

So far, have only incorporated uncertainty in mu, but not the uncertainty in predicting height from mu. This latter uncertainty is summarized by the standard deviation `sigma` for height given mu.

```{r}
## simulate heights
sim.height <- sim(m4.3, data=list(weight=weight.seq))
str(sim.height)

## summarize prediction interval
height.PI <- apply(sim.height, 2, PI, prob=0.89)

plot(height ~ weight, d2, col=col.alpha(rangi2, 0.5))
lines(weight.seq, mu.mean)
shade(mu.HPDI, weight.seq)
shade(height.PI, weight.seq)
```
